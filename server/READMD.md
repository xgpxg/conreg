# 配置/注册中心

用于通用的配置管理和服务注册，实现时考虑通用性，不要和网关项目耦合。
配置中心使用CP模式，保证数据一致性。
注册中心使用AP模式，保证服务可用性。

## 配置中心

- 配置中心用于管理系统配置，以namespace隔离，每个namespace相互独立，互不影响。
  这点参考Nacos的设计。
- 配置以KV格式存储。key为配置ID，由服务ID+环境组成，value为配置内容，格式为yaml格式，
  暂不考虑支持其他格式，但设计是应该预留扩展空间。
- 提供统一API，用于配置增删改查。
- 支持单机模式和集群模式，集群模式下使用raft实现CP模式，保证数据一致性。
- 配置中心应不依赖于外部存储，但需要支持外部存储，如Mysql等。
- 每个节点都拥有配置副本，但写入/更新操作应该仅由Leader节点执行。
- 提供获取配置的客户端SDK，需要配置注册中心地址，集群模式下可配置多个地址，
  写操作只能由Leader进行，读操作在这种配置中心场景下，也应由Leader进行，保证数据的强一致性。
  有两种方案：
    1. 初始化时从第一个开始尝试连接，如果无法连接或连接到非Leader节点，则选择下一个，
       直到成功或所有地址都尝试完毕，如果仍不能连接，则启动失败。
    2. 客户端可连接到任意节点，当连接到Follower时由节点本身内部做重定向到Leader，而不是客户端选择。
       这种模式适合数据量不大，更新不频繁的场景，所以对于配置场景是合适的。
       如果需要提高性能，那可能要牺牲一部分一致性，即运行客户端直接从Follower读，这也需要一些特殊处理，暂时不考虑。
- 提供web界面，用于管理配置

为什么需要raft来实现一致性？

1. 配置中心需要保证数据一致性，即多个节点的配置数据一致，在没有集中存储的情况下，需要一致性算法来保证数据集的一致性。
2. raft不能保证每个节点的的实时一致性，因为数据同步需要时间，但是由于raft要求只能由一个Leader节点对外提供服务，
   所以对于客户端来说，是实时的强一致性的。

## 注册中心

- 注册中心用于服务的注册、发现、健康管理等等，同样以namespace隔离。
- 设计一个NamingService，用于按照服务名查找对应的服务实例列表。
- 提供统一API，用于服务注册、服务发现、服务实例管理等等。
- 使用gossip实现AP模式，保证集群的可用性。
- 使用客户端负载均衡，提供SDK获取命名空间下的服务列表，使用配置的负载策略选择合适的实例调用。
- 提供web界面，用于管理服务实例

# Raft集群管理

- 初始化单节点集群

```shell
curl -X POST http://localhost:8000/init -d '[]'
```

- 初始化多节点集群
```shell
curl -X POST http://localhost:8000/init -d '[]'
```